<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Křišťálová hra</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
      background-size: cover;
      color: white; margin: 0; padding: 0;
    }
    header { display: flex; justify-content: space-between; background: rgba(0,0,0,0.7); padding: 10px 20px; align-items: center; }
    #usernameDisplay { font-weight: bold; }
    #logoutBtn { cursor: pointer; background: crimson; border: none; color: white; padding: 5px 10px; border-radius: 4px; display: none; }
    #authButtons button { margin-left: 10px; cursor: pointer; background: #2196F3; border: none; color: white; padding: 5px 12px; border-radius: 4px; }
    #authForms { position: fixed; top: 50px; right: 20px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; display: none; flex-direction: column; width: 240px; }
    #authForms form { display: flex; flex-direction: column; }
    #authForms input { margin: 5px 0 10px 0; padding: 6px; border-radius: 4px; border: none; }
    #authForms button { background: #4CAF50; border: none; color: white; padding: 7px; border-radius: 4px; cursor: pointer; }
    #authForms a { color: #4CAF50; cursor: pointer; font-size: 0.9em; margin-top: 5px; text-align: center; }

    main { text-align: center; margin-top: 60px; background: rgba(0,0,0,0.5); max-width: 1000px; margin-left: auto; margin-right: auto; padding: 20px; border-radius: 10px; }
    .gameBtn { margin: 10px 5px; padding: 12px 16px; font-size: 1em; border-radius: 8px; border: none; cursor: pointer; background: #007bff; color: white; transition: background-color 0.2s ease; }
    .gameBtn:disabled { background: #444; cursor: not-allowed; }
    .special-btn { background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7, #DDA0DD); background-size: 300% 300%; animation: gradientShift 3s ease infinite; }
    @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }

    .stats { margin-top: 20px; font-size: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; text-align: left; }
    .stats p { margin: 6px 0; }

    /* Shop */
    #shopToggle { margin-top: 10px; background: #9C27B0; }
    #shop { margin-top: 15px; background: rgba(0,0,0,0.6); border-radius: 10px; padding: 12px; display: none; text-align: left; }
    .shop-row { display: grid; grid-template-columns: 1.2fr 0.8fr 0.8fr 0.8fr auto; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .shop-row:last-child { border-bottom: none; }
    .muted { opacity: 0.7; font-size: 0.9em; }
    .locked { opacity: 0.5; }
    .req { font-size: 0.9em; }
    .legendary { border: 2px solid #FFD700; background: rgba(255, 215, 0, 0.1); border-radius: 5px; }
    .mythic { border: 2px solid #DA70D6; background: rgba(218, 112, 214, 0.1); border-radius: 5px; }

    /* Rebirth sekce */
    #rebirthToggle { margin-top: 10px; background: #E91E63; }
    #rebirthSection { margin-top: 15px; background: rgba(0,0,0,0.6); border-radius: 10px; padding: 12px; display: none; text-align: left; }
    #rebirthSection h3 { margin-top: 0; color: #E91E63; }
    #rebirthSection p { margin: 8px 0; }
    .rebirth-btn { background: #E91E63 !important; }
    .rebirth-bonus { color: #FFC107; font-weight: bold; }
    .rebirth-cost { color: #4CAF50; font-weight: bold; }
    .rebirth-points { color: #00BCD4; font-weight: bold; }
    .rebirth-upgrade { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .rebirth-upgrade:last-child { border-bottom: none; }

    /* Luck System */
    #luckSection { margin-top: 15px; background: rgba(255, 215, 0, 0.1); border: 2px solid #FFD700; border-radius: 10px; padding: 12px; }
    .luck-stat { color: #FFD700; font-weight: bold; }
    .mystery-box { color: #DA70D6; font-weight: bold; }

    /* Žebříček */
    #leaderboardToggle { margin-top: 10px; background: #FF9800; }
    #leaderboard { margin-top: 15px; background: rgba(0,0,0,0.6); border-radius: 10px; padding: 12px; display: none; text-align: left; }
    .leaderboard-tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { background: #555; border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; }
    .tab-btn.active { background: #FF9800; }
    .leaderboard-list { max-height: 300px; overflow-y: auto; }
    .leaderboard-item { display: grid; grid-template-columns: 40px 1fr auto; gap: 10px; align-items: center; padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .leaderboard-item:last-child { border-bottom: none; }
    .rank { font-weight: bold; color: #FFD700; }
    .rank.first { color: #FFD700; }
    .rank.second { color: #C0C0C0; }
    .rank.third { color: #CD7F32; }
    .username { font-weight: bold; }
    .value { text-align: right; }
    .error-message { color: #ff6b6b; text-align: center; padding: 10px; }
    .loading-message { color: #4CAF50; text-align: center; padding: 10px; }

    /* Notifications */
    .notification { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 8px; z-index: 1000; max-width: 300px; display: none; }
    .notification.success { border-left: 4px solid #4CAF50; }
    .notification.warning { border-left: 4px solid #FF9800; }
    .notification.info { border-left: 4px solid #2196F3; }
    .notification.error { border-left: 4px solid #f44336; }
  </style>
</head>
<body>
<header>
  <div id="usernameDisplay"></div>
  <div id="authButtons">
    <button id="showLogin">Přihlásit se</button>
    <button id="showRegister">Registrovat</button>
  </div>
  <button id="logoutBtn">Odhlásit se</button>
</header>

<div id="authForms">
  <div id="loginForm">
    <form>
      <input id="loginUsername" type="text" placeholder="Uživatelské jméno" required />
      <input id="loginPassword" type="password" placeholder="Heslo" required />
      <button type="submit">Přihlásit se</button>
    </form>
    <a id="toRegister">Nemáš účet? Registrovat</a>
  </div>
  <div id="registerForm" style="display:none;">
    <form>
      <input id="registerUsername" type="text" placeholder="Uživatelské jméno" required />
      <input id="registerPassword" type="password" placeholder="Heslo" required />
      <button type="submit">Registrovat</button>
    </form>
    <a id="toLogin">Máš účet? Přihlásit se</a>
  </div>
</div>

<div id="notification" class="notification"></div>

<main>
  <h1>Křišťálová hra</h1>
  <p id="crystalsCount">Křišťály: 0</p>
  <p id="lifetimeCrystals" class="muted">Celkem křišťálů: 0</p>

  <div class="stats">
    <p>Autoklikery: <span id="autoclickersCount">0</span> <span class="muted">(+1/s každý)</span></p>
    <p>Továrny: <span id="factoriesCount">0</span> <span class="muted">(+5/s každá)</span></p>
    <p>Doly: <span id="minesCount">0</span> <span class="muted">(+50/s každý)</span></p>
    <p>Rafinerie: <span id="refineriesCount">0</span> <span class="muted">(+200/s každá)</span></p>
    <p>Kvantové vrtačky: <span id="quantumDrillsCount">0</span> <span class="muted">(+1K/s každá)</span></p>
    <p>Magické studny: <span id="magicWellsCount">0</span> <span class="muted">(+5K/s každá)</span></p>
    <p>Hvězdné kovárny: <span id="starForgesCount">0</span> <span class="muted">(+25K/s každá)</span></p>
    <p>Časové akcelerátory: <span id="timeAcceleratorsCount">0</span> <span class="muted">(+100K/s každý)</span></p>
    <p>Prázdnotní žněče: <span id="voidHarvestersCount">0</span> <span class="muted">(+500K/s každý)</span></p>
    <p>Síla kliku: <span id="clickPowerCount">1</span> <span class="muted">(+X/klik)</span></p>
    <p>Rebirthy: <span id="rebirthCount">0</span> <span class="muted">(+bonusy)</span></p>
    <p>Rebirth body: <span id="rebirthPoints" class="rebirth-points">0</span></p>
  </div>

  <!-- Luck System -->
  <div id="luckSection">
    <p><span class="luck-stat">Luck Level: <span id="luckLevel">0</span></span> | <span class="mystery-box">Mystery Boxy: <span id="mysteryBoxes">0</span></span></p>
    <button id="claimLuckBtn" class="gameBtn special-btn">Získat Luck Bonus (1h cooldown)</button>
    <button id="openMysteryBoxBtn" class="gameBtn special-btn" disabled>Otevřít Mystery Box</button>
  </div>

  <button id="clickBtn" class="gameBtn">Klikni na křišťál (+<span id="perClick">1</span>)</button>

  <p class="muted">Současná produkce: <strong><span id="perSecond">0</span>/s</strong></p>

  <button id="shopToggle" class="gameBtn">Otevřít obchod</button>
  <div id="shop">
    <div class="shop-row" id="row-autoclicker">
      <div><strong>Autokliker</strong> <span class="muted">(+1/s)</span></div>
      <div>Cena: <span id="priceAutoclickerLabel">5</span></div>
      <div>Máš: <span id="autoclickersOwned">0</span></div>
      <div class="req"></div>
      <button id="buyAutoclickerBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row" id="row-factory">
      <div><strong>Továrna</strong> <span class="muted">(+5/s)</span></div>
      <div>Cena: <span id="priceFactoryLabel">50</span></div>
      <div>Máš: <span id="factoriesOwned">0</span></div>
      <div class="req" id="factoryReq">Vyžaduje 10 autoklikerů</div>
      <button id="buyFactoryBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row" id="row-mine">
      <div><strong>Důl</strong> <span class="muted">(+50/s)</span></div>
      <div>Cena: <span id="priceMineLabel">500</span></div>
      <div>Máš: <span id="minesOwned">0</span></div>      
      <div class="req" id="mineReq">Vyžaduje 5 továren</div>
      <button id="buyMineBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row" id="row-refinery">
      <div><strong>Rafinerie</strong> <span class="muted">(+200/s)</span></div>
      <div>Cena: <span id="priceRefineryLabel">5000</span></div>
      <div>Máš: <span id="refineriesOwned">0</span></div>
      <div class="req" id="refineryReq">Vyžaduje 3 doly</div>
      <button id="buyRefineryBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row" id="row-quantum">
      <div><strong>Kvantová vrtačka</strong> <span class="muted">(+1K/s)</span></div>
      <div>Cena: <span id="priceQuantumLabel">50000</span></div>
      <div>Máš: <span id="quantumOwned">0</span></div>
      <div class="req" id="quantumReq">Vyžaduje 2 rafinerie</div>
      <button id="buyQuantumBtn" class="gameBtn">Koupit</button>
    </div>

    <!-- Nové legendární budovy -->
    <div class="shop-row legendary" id="row-magicwell">
      <div><strong>⭐ Magická studna</strong> <span class="muted">(+5K/s)</span></div>
      <div>Cena: <span id="priceMagicWellLabel">500000</span></div>
      <div>Máš: <span id="magicWellsOwned">0</span></div>
      <div class="req" id="magicWellReq">Vyžaduje 5 kvantových vrtaček</div>
      <button id="buyMagicWellBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row legendary" id="row-starforge">
      <div><strong>⭐ Hvězdná kovárna</strong> <span class="muted">(+25K/s)</span></div>
      <div>Cena: <span id="priceStarForgeLabel">5000000</span></div>
      <div>Máš: <span id="starForgesOwned">0</span></div>
      <div class="req" id="starForgeReq">Vyžaduje 3 magické studny</div>
      <button id="buyStarForgeBtn" class="gameBtn">Koupit</button>
    </div>

    <!-- Nové mytické budovy -->
    <div class="shop-row mythic" id="row-timeaccelerator">
      <div><strong>🌟 Časový akcelerátor</strong> <span class="muted">(+100K/s)</span></div>
      <div>Cena: <span id="priceTimeAcceleratorLabel">50000000</span></div>
      <div>Máš: <span id="timeAcceleratorsOwned">0</span></div>
      <div class="req" id="timeAcceleratorReq">Vyžaduje 2 hvězdné kovárny</div>
      <button id="buyTimeAcceleratorBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row mythic" id="row-voidharvester">
      <div><strong>🌟 Prázdnotní žněč</strong> <span class="muted">(+500K/s)</span></div>
      <div>Cena: <span id="priceVoidHarvesterLabel">1000000000</span></div>
      <div>Máš: <span id="voidHarvestersOwned">0</span></div>
      <div class="req" id="voidHarvesterReq">Vyžaduje 2 časové akcelerátory</div>
      <button id="buyVoidHarvesterBtn" class="gameBtn">Koupit</button>
    </div>

    <div class="shop-row" id="row-clickpower">
      <div><strong>Vylepšit klik</strong> <span class="muted">(+1 k síle kliku)</span></div>
      <div>Cena: <span id="priceClickPowerLabel">20</span></div>
      <div>Aktuálně: <span id="clickPowerOwned">1</span></div>
      <div class="req"></div>
      <button id="upgradeClickPowerBtn" class="gameBtn">Vylepšit</button>
    </div>
  </div>

  <button id="rebirthToggle" class="gameBtn rebirth-btn">Rebirth</button>
  <div id="rebirthSection">
    <h3>Rebirth Mechanika</h3>
    <p>Rebirth resetuje tvůj postup, ale získáš <span class="rebirth-points">Rebirth body</span> pro trvalé bonusy!</p>
    <p>Potřebuješ: <span id="rebirthRequired" class="rebirth-cost">100,000</span> křišťálů</p>
    <p>Získáš: ~<span id="rebirthGain" class="rebirth-points">0</span> bodů + možnost Luck Level!</p>
    <button id="doRebirthBtn" class="gameBtn rebirth-btn" disabled>Proved Rebirth</button>
    
    <h3>Rebirth Bonusy</h3>
    <p>Máš: <span id="currentRebirthPoints" class="rebirth-points">0</span> bodů</p>
    
    <div class="rebirth-upgrade">
      <div>
        <strong>Síla kliku</strong>
        <div class="muted">Aktuální bonus: +<span id="currentClickBonus">0</span>%</div>
      </div>
      <div>Cena: <span class="rebirth-cost">10</span> bodů</div>
      <button id="upgradeClickBonusBtn" class="gameBtn rebirth-btn" disabled>Vylepšit</button>
    </div>
    
    <div class="rebirth-upgrade">
      <div>
        <strong>Produkce</strong>
        <div class="muted">Aktuální bonus: +<span id="currentProductionBonus">0</span>%</div>
      </div>
      <div>Cena: <span class="rebirth-cost">10</span> bodů</div>
      <button id="upgradeProductionBonusBtn" class="gameBtn rebirth-btn" disabled>Vylepšit</button>
    </div>
    
    <div class="rebirth-upgrade">
      <div>
        <strong>Rebirth body</strong>
        <div class="muted">Aktuální bonus: +<span id="currentPointsBonus">0</span>%</div>
      </div>
      <div>Cena: <span class="rebirth-cost">10</span> bodů</div>
      <button id="upgradePointsBonusBtn" class="gameBtn rebirth-btn" disabled>Vylepšit</button>
    </div>
  </div>

  <button id="leaderboardToggle" class="gameBtn">Žebříček hráčů</button>
  <div id="leaderboard">
    <div class="leaderboard-tabs">
      <button class="tab-btn active" data-type="crystals">Křišťály</button>
      <button class="tab-btn" data-type="cps">CPS</button>
      <button class="tab-btn" data-type="clicks">Kliky</button>
      <button class="tab-btn" data-type="buildings">Budovy</button>
      <button class="tab-btn" data-type="rebirth">Rebirthy</button>
      <button class="tab-btn" data-type="luck">Luck Level</button>
    </div>
    <div class="leaderboard-list" id="leaderboardContent">
      <div class="loading-message">Načítám žebříček...</div>
    </div>
  </div>
</main>

<script>
  // API BASE URL - automaticky detekuje, pokud je lokální nebo na serveru
  const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';

  // Game state
  let gameData = {
    userId: null,
    crystals: 0,
    lifetime_crystals: 0,
    autoclickers: 0,
    factories: 0,
    mines: 0,
    refineries: 0,
    quantumDrills: 0,
    magicWells: 0,
    starForges: 0,
    timeAccelerators: 0,
    voidHarvesters: 0,
    clickPower: 1,
    totalClicks: 0,
    priceAutoclicker: 5,
    priceFactory: 50,
    priceMine: 500,
    priceRefinery: 5000,
    priceQuantumDrill: 50000,
    priceMagicWell: 500000,
    priceStarForge: 5000000,
    priceTimeAccelerator: 50000000,
    priceVoidHarvester: 1000000000,
    priceClickPower: 20,
    rebirthCount: 0,
    rebirthPoints: 0,
    bonusClickPower: 0,
    bonusProduction: 0,
    bonusRebirthPoints: 0,
    luckLevel: 0,
    mysteryBoxes: 0,
    lastLuckBonus: null
  };

  // UI Elements
  const elements = {
    usernameDisplay: document.getElementById('usernameDisplay'),
    logoutBtn: document.getElementById('logoutBtn'),
    authButtons: document.getElementById('authButtons'),
    showLogin: document.getElementById('showLogin'),
    showRegister: document.getElementById('showRegister'),
    authForms: document.getElementById('authForms'),
    loginForm: document.getElementById('loginForm'),
    registerForm: document.getElementById('registerForm'),
    toLogin: document.getElementById('toLogin'),
    toRegister: document.getElementById('toRegister'),
    loginUsername: document.getElementById('loginUsername'),
    loginPassword: document.getElementById('loginPassword'),
    registerUsername: document.getElementById('registerUsername'),
    registerPassword: document.getElementById('registerPassword'),
    notification: document.getElementById('notification'),
    crystalsCount: document.getElementById('crystalsCount'),
    lifetimeCrystals: document.getElementById('lifetimeCrystals'),
    autoclickersCount: document.getElementById('autoclickersCount'),
    factoriesCount: document.getElementById('factoriesCount'),
    minesCount: document.getElementById('minesCount'),
    refineriesCount: document.getElementById('refineriesCount'),
    quantumDrillsCount: document.getElementById('quantumDrillsCount'),
    magicWellsCount: document.getElementById('magicWellsCount'),
    starForgesCount: document.getElementById('starForgesCount'),
    timeAcceleratorsCount: document.getElementById('timeAcceleratorsCount'),
    voidHarvestersCount: document.getElementById('voidHarvestersCount'),
    clickPowerCount: document.getElementById('clickPowerCount'),
    rebirthCount: document.getElementById('rebirthCount'),
    rebirthPoints: document.getElementById('rebirthPoints'),
    luckLevel: document.getElementById('luckLevel'),
    mysteryBoxes: document.getElementById('mysteryBoxes'),
    perClick: document.getElementById('perClick'),
    perSecond: document.getElementById('perSecond'),
    clickBtn: document.getElementById('clickBtn'),
    shopToggle: document.getElementById('shopToggle'),
    shop: document.getElementById('shop'),
    buyAutoclickerBtn: document.getElementById('buyAutoclickerBtn'),
    buyFactoryBtn: document.getElementById('buyFactoryBtn'),
    buyMineBtn: document.getElementById('buyMineBtn'),
    buyRefineryBtn: document.getElementById('buyRefineryBtn'),
    buyQuantumBtn: document.getElementById('buyQuantumBtn'),
    buyMagicWellBtn: document.getElementById('buyMagicWellBtn'),
    buyStarForgeBtn: document.getElementById('buyStarForgeBtn'),
    buyTimeAcceleratorBtn: document.getElementById('buyTimeAcceleratorBtn'),
    buyVoidHarvesterBtn: document.getElementById('buyVoidHarvesterBtn'),
    upgradeClickPowerBtn: document.getElementById('upgradeClickPowerBtn'),
    priceAutoclickerLabel: document.getElementById('priceAutoclickerLabel'),
    priceFactoryLabel: document.getElementById('priceFactoryLabel'),
    priceMineLabel: document.getElementById('priceMineLabel'),
    priceRefineryLabel: document.getElementById('priceRefineryLabel'),
    priceQuantumLabel: document.getElementById('priceQuantumLabel'),
    priceMagicWellLabel: document.getElementById('priceMagicWellLabel'),
    priceStarForgeLabel: document.getElementById('priceStarForgeLabel'),
    priceTimeAcceleratorLabel: document.getElementById('priceTimeAcceleratorLabel'),
    priceVoidHarvesterLabel: document.getElementById('priceVoidHarvesterLabel'),
    priceClickPowerLabel: document.getElementById('priceClickPowerLabel'),
    autoclickersOwned: document.getElementById('autoclickersOwned'),
    factoriesOwned: document.getElementById('factoriesOwned'),
    minesOwned: document.getElementById('minesOwned'),
    refineriesOwned: document.getElementById('refineriesOwned'),
    quantumOwned: document.getElementById('quantumOwned'),
    magicWellsOwned: document.getElementById('magicWellsOwned'),
    starForgesOwned: document.getElementById('starForgesOwned'),
    timeAcceleratorsOwned: document.getElementById('timeAcceleratorsOwned'),
    voidHarvestersOwned: document.getElementById('voidHarvestersOwned'),
    clickPowerOwned: document.getElementById('clickPowerOwned'),
    rebirthToggle: document.getElementById('rebirthToggle'),
    rebirthSection: document.getElementById('rebirthSection'),
    rebirthRequired: document.getElementById('rebirthRequired'),
    rebirthGain: document.getElementById('rebirthGain'),
    doRebirthBtn: document.getElementById('doRebirthBtn'),
    currentRebirthPoints: document.getElementById('currentRebirthPoints'),
    currentClickBonus: document.getElementById('currentClickBonus'),
    currentProductionBonus: document.getElementById('currentProductionBonus'),
    currentPointsBonus: document.getElementById('currentPointsBonus'),
    upgradeClickBonusBtn: document.getElementById('upgradeClickBonusBtn'),
    upgradeProductionBonusBtn: document.getElementById('upgradeProductionBonusBtn'),
    upgradePointsBonusBtn: document.getElementById('upgradePointsBonusBtn'),
    claimLuckBtn: document.getElementById('claimLuckBtn'),
    openMysteryBoxBtn: document.getElementById('openMysteryBoxBtn'),
    leaderboardToggle: document.getElementById('leaderboardToggle'),
    leaderboard: document.getElementById('leaderboard'),
    leaderboardContent: document.getElementById('leaderboardContent')
  };

  // Automatické ukládání - rychlejší frekvence pro lepší UX
  let autoSaveInterval = null;

  // API functions
  async function apiCall(endpoint, method = 'GET', data = null) {
    try {
      const config = {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        }
      };
      
      if (data) {
        config.body = JSON.stringify(data);
      }
      
      const response = await fetch(`${API_BASE}/${endpoint}`, config);
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || 'API call failed');
      }
      
      return result;
    } catch (error) {
      console.error('API call error:', error);
      throw error;
    }
  }

  async function register(username, password) {
    try {
      const result = await apiCall('register', 'POST', { username, password });
      if (result.success) {
        showNotification('Registrace úspěšná! Nyní se můžeš přihlásit.', 'success');
        elements.registerForm.style.display = 'none';
        elements.loginForm.style.display = 'block';
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při registraci', 'error');
    }
  }

  async function login(username, password) {
    try {
      const result = await apiCall('login', 'POST', { username, password });
      if (result.success) {
        gameData.userId = result.user_id;
        elements.usernameDisplay.textContent = username;
        elements.authButtons.style.display = 'none';
        elements.logoutBtn.style.display = 'block';
        elements.authForms.style.display = 'none';
        
        showNotification('Přihlášení úspěšné!', 'success');
        
        // Načtení hráčova postupu
        await loadGame();
        
        // Spuštění pravidelného ukládání - každé 3 sekundy pro lepší UX
        startAutoSave();
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při přihlašování', 'error');
    }
  }

  async function loadGame() {
    try {
      const result = await apiCall(`load_game?user_id=${gameData.userId}`);
      if (result.success) {
        Object.assign(gameData, result.game_data);
        updateUI();
        showNotification('Hra načtena!', 'info');
      }
    } catch (error) {
      showNotification('Chyba při načítání hry', 'error');
    }
  }

  async function saveGame() {
    if (!gameData.userId) return;
    
    try {
      await apiCall('save_game', 'POST', {
        user_id: gameData.userId,
        game_data: gameData
      });
    } catch (error) {
      console.error('Chyba při ukládání:', error);
    }
  }

  function startAutoSave() {
    // Automatické ukládání každé 3 sekundy pro okamžité ukládání změn
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(saveGame, 3000);
    
    // Ukládání při zavření stránky
    window.addEventListener('beforeunload', saveGame);
  }

  function logout() {
    saveGame(); // Uložit před odhlášením
    
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    
    gameData.userId = null;
    Object.assign(gameData, {
      crystals: 0,
      lifetime_crystals: 0,
      autoclickers: 0,
      factories: 0,
      mines: 0,
      refineries: 0,
      quantumDrills: 0,
      magicWells: 0,
      starForges: 0,
      timeAccelerators: 0,
      voidHarvesters: 0,
      clickPower: 1,
      totalClicks: 0,
      priceAutoclicker: 5,
      priceFactory: 50,
      priceMine: 500,
      priceRefinery: 5000,
      priceQuantumDrill: 50000,
      priceMagicWell: 500000,
      priceStarForge: 5000000,
      priceTimeAccelerator: 50000000,
      priceVoidHarvester: 1000000000,
      priceClickPower: 20,
      rebirthCount: 0,
      rebirthPoints: 0,
      bonusClickPower: 0,
      bonusProduction: 0,
      bonusRebirthPoints: 0,
      luckLevel: 0,
      mysteryBoxes: 0
    });
    
    elements.usernameDisplay.textContent = '';
    elements.authButtons.style.display = 'block';
    elements.logoutBtn.style.display = 'none';
    
    updateUI();
    showNotification('Odhlášení úspěšné', 'success');
  }

  // Game functions
  function updateUI() {
    // Update main display
    elements.crystalsCount.textContent = `Křišťály: ${formatNumber(gameData.crystals)}`;
    elements.lifetimeCrystals.textContent = `Celkem křišťálů: ${formatNumber(gameData.lifetime_crystals)}`;
    
    // Update building counts
    elements.autoclickersCount.textContent = gameData.autoclickers;
    elements.factoriesCount.textContent = gameData.factories;
    elements.minesCount.textContent = gameData.mines;
    elements.refineriesCount.textContent = gameData.refineries;
    elements.quantumDrillsCount.textContent = gameData.quantumDrills;
    elements.magicWellsCount.textContent = gameData.magicWells;
    elements.starForgesCount.textContent = gameData.starForges;
    elements.timeAcceleratorsCount.textContent = gameData.timeAccelerators;
    elements.voidHarvestersCount.textContent = gameData.voidHarvesters;
    elements.clickPowerCount.textContent = gameData.clickPower;
    elements.rebirthCount.textContent = gameData.rebirthCount;
    elements.rebirthPoints.textContent = gameData.rebirthPoints;
    
    // Update click power and CPS
    const effectiveClickPower = Math.floor(gameData.clickPower * (1 + gameData.bonusClickPower / 100));
    elements.perClick.textContent = effectiveClickPower;
    elements.perSecond.textContent = formatNumber(calculateCPS());
    
    // Update shop
    elements.priceAutoclickerLabel.textContent = formatNumber(gameData.priceAutoclicker);
    elements.priceFactoryLabel.textContent = formatNumber(gameData.priceFactory);
    elements.priceMineLabel.textContent = formatNumber(gameData.priceMine);
    elements.priceRefineryLabel.textContent = formatNumber(gameData.priceRefinery);
    elements.priceQuantumLabel.textContent = formatNumber(gameData.priceQuantumDrill);
    elements.priceMagicWellLabel.textContent = formatNumber(gameData.priceMagicWell);
    elements.priceStarForgeLabel.textContent = formatNumber(gameData.priceStarForge);
    elements.priceTimeAcceleratorLabel.textContent = formatNumber(gameData.priceTimeAccelerator);
    elements.priceVoidHarvesterLabel.textContent = formatNumber(gameData.priceVoidHarvester);
    elements.priceClickPowerLabel.textContent = formatNumber(gameData.priceClickPower);
    
    elements.autoclickersOwned.textContent = gameData.autoclickers;
    elements.factoriesOwned.textContent = gameData.factories;
    elements.minesOwned.textContent = gameData.mines;
    elements.refineriesOwned.textContent = gameData.refineries;
    elements.quantumOwned.textContent = gameData.quantumDrills;
    elements.magicWellsOwned.textContent = gameData.magicWells;
    elements.starForgesOwned.textContent = gameData.starForges;
    elements.timeAcceleratorsOwned.textContent = gameData.timeAccelerators;
    elements.voidHarvestersOwned.textContent = gameData.voidHarvesters;
    elements.clickPowerOwned.textContent = gameData.clickPower;
    
    // Update rebirth section
    const requiredRebirth = 100000 * Math.pow(2, gameData.rebirthCount);
    elements.rebirthRequired.textContent = formatNumber(requiredRebirth);
    const rebirthGain = gameData.crystals > 0 ? Math.floor(Math.log10(gameData.crystals) * (1 + gameData.bonusRebirthPoints/100)) : 0;
    elements.rebirthGain.textContent = rebirthGain;
    elements.doRebirthBtn.disabled = gameData.crystals < requiredRebirth;
    
    elements.currentRebirthPoints.textContent = gameData.rebirthPoints;
    elements.currentClickBonus.textContent = gameData.bonusClickPower;
    elements.currentProductionBonus.textContent = gameData.bonusProduction;
    elements.currentPointsBonus.textContent = gameData.bonusRebirthPoints;
    
    elements.upgradeClickBonusBtn.disabled = gameData.rebirthPoints < 10;
    elements.upgradeProductionBonusBtn.disabled = gameData.rebirthPoints < 10;
    elements.upgradePointsBonusBtn.disabled = gameData.rebirthPoints < 10;
    
    // Update luck system
    elements.luckLevel.textContent = gameData.luckLevel;
    elements.mysteryBoxes.textContent = gameData.mysteryBoxes;
    elements.openMysteryBoxBtn.disabled = gameData.mysteryBoxes <= 0;
    
    // Update building requirements
    updateBuildingRequirements();
  }

  function calculateCPS() {
    const baseCPS = 
      gameData.autoclickers * 1 + 
      gameData.factories * 5 + 
      gameData.mines * 50 + 
      gameData.refineries * 200 + 
      gameData.quantumDrills * 1000 +
      gameData.magicWells * 5000 +
      gameData.starForges * 25000 +
      gameData.timeAccelerators * 100000 +
      gameData.voidHarvesters * 500000;
    
    return baseCPS * (1 + gameData.bonusProduction / 100);
  }

  function updateBuildingRequirements() {
    // Factory requires 10 autoclickers
    const factoryReq = document.getElementById('factoryReq');
    if (gameData.autoclickers >= 10) {
      factoryReq.classList.remove('locked');
      elements.buyFactoryBtn.disabled = gameData.crystals < gameData.priceFactory;
    } else {
      factoryReq.classList.add('locked');
      elements.buyFactoryBtn.disabled = true;
    }
    
    // Mine requires 5 factories
    const mineReq = document.getElementById('mineReq');
    if (gameData.factories >= 5) {
      mineReq.classList.remove('locked');
      elements.buyMineBtn.disabled = gameData.crystals < gameData.priceMine;
    } else {
      mineReq.classList.add('locked');
      elements.buyMineBtn.disabled = true;
    }
    
    // Refinery requires 3 mines
    const refineryReq = document.getElementById('refineryReq');
    if (gameData.mines >= 3) {
      refineryReq.classList.remove('locked');
      elements.buyRefineryBtn.disabled = gameData.crystals < gameData.priceRefinery;
    } else {
      refineryReq.classList.add('locked');
      elements.buyRefineryBtn.disabled = true;
    }
    
    // Quantum drill requires 2 refineries
    const quantumReq = document.getElementById('quantumReq');
    if (gameData.refineries >= 2) {
      quantumReq.classList.remove('locked');
      elements.buyQuantumBtn.disabled = gameData.crystals < gameData.priceQuantumDrill;
    } else {
      quantumReq.classList.add('locked');
      elements.buyQuantumBtn.disabled = true;
    }
    
    // Magic well requires 5 quantum drills
    const magicWellReq = document.getElementById('magicWellReq');
    if (gameData.quantumDrills >= 5) {
      magicWellReq.classList.remove('locked');
      elements.buyMagicWellBtn.disabled = gameData.crystals < gameData.priceMagicWell;
    } else {
      magicWellReq.classList.add('locked');
      elements.buyMagicWellBtn.disabled = true;
    }
    
    // Star forge requires 3 magic wells
    const starForgeReq = document.getElementById('starForgeReq');
    if (gameData.magicWells >= 3) {
      starForgeReq.classList.remove('locked');
      elements.buyStarForgeBtn.disabled = gameData.crystals < gameData.priceStarForge;
    } else {
      starForgeReq.classList.add('locked');
      elements.buyStarForgeBtn.disabled = true;
    }
    
    // Time accelerator requires 2 star forges
    const timeAcceleratorReq = document.getElementById('timeAcceleratorReq');
    if (gameData.starForges >= 2) {
      timeAcceleratorReq.classList.remove('locked');
      elements.buyTimeAcceleratorBtn.disabled = gameData.crystals < gameData.priceTimeAccelerator;
    } else {
      timeAcceleratorReq.classList.add('locked');
      elements.buyTimeAcceleratorBtn.disabled = true;
    }
    
    // Void harvester requires 2 time accelerators
    const voidHarvesterReq = document.getElementById('voidHarvesterReq');
    if (gameData.timeAccelerators >= 2) {
      voidHarvesterReq.classList.remove('locked');
      elements.buyVoidHarvesterBtn.disabled = gameData.crystals < gameData.priceVoidHarvester;
    } else {
      voidHarvesterReq.classList.add('locked');
      elements.buyVoidHarvesterBtn.disabled = true;
    }
    
    // Basic building buttons
    elements.buyAutoclickerBtn.disabled = gameData.crystals < gameData.priceAutoclicker;
    elements.upgradeClickPowerBtn.disabled = gameData.crystals < gameData.priceClickPower;
  }

  function formatNumber(num) {
    if (num >= 1000000000) {
      return (num / 1000000000).toFixed(2) + 'B';
    }
    if (num >= 1000000) {
      return (num / 1000000).toFixed(2) + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(2) + 'K';
    }
    return Math.floor(num).toString();
  }

  function showNotification(message, type = 'success', duration = 3000) {
    const notification = elements.notification;
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, duration);
  }

  function buyBuilding(buildingType) {
  const buildingMap = {
    Autoclicker: 'autoclickers',
    Factory: 'factories',
    Mine: 'mines',
    Refinery: 'refineries',
    QuantumDrill: 'quantumDrills',
    MagicWell: 'magicWells',
    StarForge: 'starForges',
    TimeAccelerator: 'timeAccelerators',
    VoidHarvester: 'voidHarvesters'
  };

  const priceKey = `price${buildingType}`;
  const countKey = buildingMap[buildingType];

  if (!countKey) {
    console.error(`Neznámý typ budovy: ${buildingType}`);
    return false;
  }

  if (gameData.crystals < gameData[priceKey]) {
    showNotification('Nemáš dost křišťálů!', 'warning');
    return false;
  }

  gameData.crystals -= gameData[priceKey];
  gameData[countKey]++;

  // zvýšení ceny o 15 %
  gameData[priceKey] = Math.floor(gameData[priceKey] * 1.15);

  updateUI();
  saveGame();
  showNotification(`Koupil jsi ${buildingType}!`, 'success');
  return true;
}


  function upgradeClickPower() {
    if (gameData.crystals < gameData.priceClickPower) {
      showNotification('Nemáš dost křišťálů!', 'warning');
      return false;
    }
    
    gameData.crystals -= gameData.priceClickPower;
    gameData.clickPower++;
    
    // Zvýšení ceny o 20% s každým vylepšením
    gameData.priceClickPower = Math.floor(gameData.priceClickPower * 1.2);
    
    updateUI();
    // OKAMŽITÉ ULOŽENÍ po vylepšení
    saveGame();
    showNotification('Vylepšil jsi sílu kliku!', 'success');
    return true;
  }

  async function loadLeaderboard(type = 'crystals') {
    try {
      elements.leaderboardContent.innerHTML = '<div class="loading-message">Načítám žebříček...</div>';
      
      const result = await apiCall(`leaderboard?type=${type}`);
      if (result.success) {
        let html = '';
        result.leaderboard.forEach(player => {
          const rankClass = player.rank === 1 ? 'first' : player.rank === 2 ? 'second' : player.rank === 3 ? 'third' : '';
          html += `
            <div class="leaderboard-item">
              <div class="rank ${rankClass}">${player.rank}.</div>
              <div class="username">${player.username}</div>
              <div class="value">${formatNumber(player.value)}</div>
            </div>
          `;
        });
        
        if (html === '') {
          html = '<div class="error-message">Žádní hráči v žebříčku</div>';
        }
        
        elements.leaderboardContent.innerHTML = html;
      }
    } catch (error) {
      elements.leaderboardContent.innerHTML = '<div class="error-message">Chyba při načítání žebříčku</div>';
    }
  }

  // Game loop
  function gameLoop() {
    const cps = calculateCPS();
    if (cps > 0 && gameData.userId) {
      const gain = cps / 10; // Dělíme 10, protože loop běží 10x za sekundu
      gameData.crystals += gain;
      gameData.lifetime_crystals += gain;
      updateUI();
    }
  }

  // Event listeners
  elements.showLogin.addEventListener('click', () => {
    elements.authForms.style.display = 'flex';
    elements.loginForm.style.display = 'block';
    elements.registerForm.style.display = 'none';
  });

  elements.showRegister.addEventListener('click', () => {
    elements.authForms.style.display = 'flex';
    elements.loginForm.style.display = 'none';
    elements.registerForm.style.display = 'block';
  });

  elements.toRegister.addEventListener('click', () => {
    elements.loginForm.style.display = 'none';
    elements.registerForm.style.display = 'block';
  });

  elements.toLogin.addEventListener('click', () => {
    elements.loginForm.style.display = 'block';
    elements.registerForm.style.display = 'none';
  });

  elements.logoutBtn.addEventListener('click', logout);

  // Close auth forms when clicking outside
  document.addEventListener('click', (e) => {
    if (!elements.authForms.contains(e.target) && 
        !elements.showLogin.contains(e.target) && 
        !elements.showRegister.contains(e.target)) {
      elements.authForms.style.display = 'none';
    }
  });

  // Form submissions
  elements.loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = elements.loginUsername.value.trim();
    const password = elements.loginPassword.value.trim();
    await login(username, password);
  });

  elements.registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = elements.registerUsername.value.trim();
    const password = elements.registerPassword.value.trim();
    await register(username, password);
  });

  // Main game buttons
  elements.clickBtn.addEventListener('click', () => {
    if (!gameData.userId) {
      showNotification('Musíš se přihlásit pro hraní!', 'warning');
      return;
    }
    
    const clickValue = Math.floor(gameData.clickPower * (1 + gameData.bonusClickPower / 100));
    gameData.crystals += clickValue;
    gameData.lifetime_crystals += clickValue;
    gameData.totalClicks++;
    updateUI();
    
    // Visual feedback for click
    elements.clickBtn.style.transform = 'scale(0.95)';
    setTimeout(() => {
      elements.clickBtn.style.transform = 'scale(1)';
    }, 100);
  });

  elements.shopToggle.addEventListener('click', () => {
    elements.shop.style.display = elements.shop.style.display === 'none' ? 'block' : 'none';
  });

  elements.rebirthToggle.addEventListener('click', () => {
    elements.rebirthSection.style.display = elements.rebirthSection.style.display === 'none' ? 'block' : 'none';
  });

  elements.leaderboardToggle.addEventListener('click', () => {
    elements.leaderboard.style.display = elements.leaderboard.style.display === 'none' ? 'block' : 'none';
    if (elements.leaderboard.style.display === 'block') {
      loadLeaderboard('crystals');
    }
  });

  // Building purchase buttons
  elements.buyAutoclickerBtn.addEventListener('click', () => buyBuilding('Autoclicker'));
  elements.buyFactoryBtn.addEventListener('click', () => buyBuilding('Factory'));
  elements.buyMineBtn.addEventListener('click', () => buyBuilding('Mine'));
  elements.buyRefineryBtn.addEventListener('click', () => buyBuilding('Refinery'));
  elements.buyQuantumBtn.addEventListener('click', () => buyBuilding('QuantumDrill'));
  elements.buyMagicWellBtn.addEventListener('click', () => buyBuilding('MagicWell'));
  elements.buyStarForgeBtn.addEventListener('click', () => buyBuilding('StarForge'));
  elements.buyTimeAcceleratorBtn.addEventListener('click', () => buyBuilding('TimeAccelerator'));
  elements.buyVoidHarvesterBtn.addEventListener('click', () => buyBuilding('VoidHarvester'));
  elements.upgradeClickPowerBtn.addEventListener('click', upgradeClickPower);

  // Rebirth system
  elements.doRebirthBtn.addEventListener('click', async () => {
    if (!gameData.userId) {
      showNotification('Musíš se přihlásit pro rebirth!', 'warning');
      return;
    }
    
    try {
      const result = await apiCall('rebirth', 'POST', { user_id: gameData.userId });
      if (result.success) {
        // Reset local game data
        Object.assign(gameData, {
          crystals: 0,
          autoclickers: 0,
          factories: 0,
          mines: 0,
          refineries: 0,
          quantumDrills: 0,
          magicWells: 0,
          starForges: 0,
          timeAccelerators: 0,
          voidHarvesters: 0,
          clickPower: 1,
          priceAutoclicker: 5,
          priceFactory: 50,
          priceMine: 500,
          priceRefinery: 5000,
          priceQuantumDrill: 50000,
          priceMagicWell: 500000,
          priceStarForge: 5000000,
          priceTimeAccelerator: 50000000,
          priceVoidHarvester: 1000000000,
          priceClickPower: 20,
          rebirthCount: result.rebirthCount,
          rebirthPoints: result.rebirthPoints,
          luckLevel: result.luckLevel
        });
        
        updateUI();
        
        let message = `Rebirth úspěšný! Získal jsi ${result.gainedPoints} bodů!`;
        if (result.luckGained > 0) {
          message += ` + ${result.luckGained} Luck Level!`;
        }
        showNotification(message, 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při rebirthu', 'error');
    }
  });

  // Rebirth upgrades
  elements.upgradeClickBonusBtn.addEventListener('click', async () => {
    if (!gameData.userId) return;
    
    try {
      const result = await apiCall('upgrade_rebirth', 'POST', {
        user_id: gameData.userId,
        type: 'click'
      });
      if (result.success) {
        gameData.bonusClickPower = result.newValue;
        gameData.rebirthPoints = result.remainingPoints;
        updateUI();
        showNotification('Vylepšil jsi bonus síly kliku!', 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při upgradu', 'error');
    }
  });

  elements.upgradeProductionBonusBtn.addEventListener('click', async () => {
    if (!gameData.userId) return;
    
    try {
      const result = await apiCall('upgrade_rebirth', 'POST', {
        user_id: gameData.userId,
        type: 'production'
      });
      if (result.success) {
        gameData.bonusProduction = result.newValue;
        gameData.rebirthPoints = result.remainingPoints;
        updateUI();
        showNotification('Vylepšil jsi bonus produkce!', 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při upgradu', 'error');
    }
  });

  elements.upgradePointsBonusBtn.addEventListener('click', async () => {
    if (!gameData.userId) return;
    
    try {
      const result = await apiCall('upgrade_rebirth', 'POST', {
        user_id: gameData.userId,
        type: 'points'
      });
      if (result.success) {
        gameData.bonusRebirthPoints = result.newValue;
        gameData.rebirthPoints = result.remainingPoints;
        updateUI();
        showNotification('Vylepšil jsi bonus rebirth bodů!', 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při upgradu', 'error');
    }
  });

  // Luck system
  elements.claimLuckBtn.addEventListener('click', async () => {
    if (!gameData.userId) {
      showNotification('Musíš se přihlásit pro luck bonus!', 'warning');
      return;
    }
    
    try {
      const result = await apiCall('claim_luck_bonus', 'POST', { user_id: gameData.userId });
      if (result.success) {
        gameData.crystals += result.bonus;
        gameData.lifetime_crystals += result.bonus;
        
        if (result.got_mystery_box) {
          gameData.mysteryBoxes++;
        }
        
        updateUI();
        
        let message = `Luck bonus: ${formatNumber(result.bonus)} křišťálů!`;
        if (result.got_mystery_box) {
          message += ' + Mystery Box!';
        }
        showNotification(message, 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při získávání luck bonusu', 'error');
    }
  });

  elements.openMysteryBoxBtn.addEventListener('click', async () => {
    if (!gameData.userId) {
      showNotification('Musíš se přihlásit pro mystery box!', 'warning');
      return;
    }
    
    try {
      const result = await apiCall('open_mystery_box', 'POST', { user_id: gameData.userId });
      if (result.success) {
        gameData.mysteryBoxes--;
        
        const reward = result.reward;
        if (reward.type === 'crystals' || reward.type === 'production_boost') {
          gameData.crystals += reward.amount;
          gameData.lifetime_crystals += reward.amount;
        } else if (reward.type === 'click_power') {
          gameData.clickPower += reward.amount;
        }
        
        updateUI();
        showNotification(`Mystery Box: +${reward.amount} ${reward.name}!`, 'success');
      }
    } catch (error) {
      showNotification(error.message || 'Chyba při otvírání mystery boxu', 'error');
    }
  });

  // Tab switching for leaderboard
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const type = btn.getAttribute('data-type');
      loadLeaderboard(type);
    });
  });

  // Initialization
  updateUI();
  setInterval(gameLoop, 100); // Game loop runs 10 times per second
  
  // Show initial info
  showNotification('Vítej v Křišťálové hře! Přihlas se pro online režim.', 'info', 5000);
</script>
</body>
</html>
